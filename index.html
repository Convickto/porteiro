<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Porteiro Virtual</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f7f7f7;
      display: flex;
      flex-direction: column;
      height: 100vh;
      text-align: center;
    }

    h1 {
      font-size: 6vw;
      background: #2c3e50;
      color: white;
      padding: 20px 10px;
      margin: 0;
    }

    #map {
      height: 50vh; /* ocupa metade da tela */
      width: 100%;
    }

    #message {
      flex: 1;
      padding: 20px;
      font-size: 5vw;
      color: #333;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    #message p {
      margin: 10px 0;
    }

    footer {
      height: 40px; /* espaço extra para barra do navegador */
      background: transparent;
    }
  </style>
</head>
<body>
  <h1>Porteiro Virtual</h1>
  <div id="map"></div>
  <div id="message">
    <p><strong>Ative sua localização</strong></p>
    <p>Estamos verificando se você está em frente ao portão...</p>
    <p id="status"></p>
  </div>
  <footer></footer>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Localização do portão
    const gateLat = -23.7498280;
    const gateLng = -46.6989196;
    const radius = 20; // RAIO AJUSTADO PARA 20 METROS

    // Inicializa o mapa
    const map = L.map('map').setView([gateLat, gateLng], 18);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);

    // Marcador do portão
    const gateMarker = L.marker([gateLat, gateLng]).addTo(map).bindPopup("Portão").openPopup();

    // Círculo de raio permitido
    const circle = L.circle([gateLat, gateLng], {
      color: 'blue',
      fillColor: '#a0c4ff',
      fillOpacity: 0.3,
      radius: radius
    }).addTo(map);

    // Função para calcular distância
    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000; // raio da Terra em metros
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a =
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // Captura localização do usuário
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(position => {
        const userLat = position.coords.latitude;
        const userLng = position.coords.longitude;

        // Marca usuário no mapa
        const userMarker = L.marker([userLat, userLng], {color: 'red'}).addTo(map).bindPopup("Você").openPopup();

        // Calcula distância
        const distance = getDistance(userLat, userLng, gateLat, gateLng);

        const status = document.getElementById('status');
        if (distance <= radius) {
          status.innerHTML = `<span style="color:green;">✅ Você está dentro da área permitida (${Math.round(distance)}m)</span>`;
          // Redireciona automaticamente
          window.location.href = "https://danielcjmelo.wixstudio.com/porteiro";
        } else {
          status.innerHTML = `<span style="color:red;">❌ Você está fora da área permitida (${Math.round(distance)}m)</span>`;
        }

      }, () => {
        document.getElementById('status').innerText = "⚠️ Permita o acesso à sua localização para continuar.";
      });
    } else {
      document.getElementById('status').innerText = "⚠️ Seu dispositivo não suporta geolocalização.";
    }
  </script>
</body>
</html>
